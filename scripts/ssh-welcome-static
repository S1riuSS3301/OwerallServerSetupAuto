#!/bin/bash
# Статичная версия приветственного экрана для tmux окна
# Показывает информацию без очистки экрана

# Цвета для вывода
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Функция получения информации о системе
get_system_info() {
    echo -e "${CYAN}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${WHITE}                  AURORA NSCI                  ${CYAN}║${NC}"
    echo -e "${CYAN}╠══════════════════════════════════════════════════════════════╣${NC}"
    
    # Основная информация
    echo -e "${CYAN}║${NC} Система: ${GREEN}$(uname -s) $(uname -r)${NC}"
    echo -e "${CYAN}║${NC} Время работы: ${GREEN}$(uptime -p)${NC}"
    echo -e "${CYAN}║${NC} Дата: ${GREEN}$(date '+%Y-%m-%d %H:%M:%S')${NC}"
    
    # Информация о ресурсах
    echo -e "${CYAN}║${NC}"
    echo -e "${CYAN}║${GREEN} Частота CPU: $(cat /proc/cpuinfo | grep 'cpu MHz' | head -1 | awk '{printf "%.2f GHz", $4/1000}')${NC}"
    echo -e "${CYAN}║${GREEN} Использование RAM: $(free -h | awk 'NR==2{print $3 "/" $2}')${NC}"
    echo -e "${CYAN}║${GREEN} Свободное место: $(df -h / | awk 'NR==2{print $4}') доступно${NC}"
    
    # Проверка статуса перезагрузки
    if [ -f /tmp/server-status ]; then
        source /tmp/server-status
        if [ "$REBOOT_REQUIRED" = "true" ]; then
            echo -e "${CYAN}║${NC}"
            echo -e "${CYAN}║${RED} ⚠️  ТРЕБУЕТСЯ ПЕРЕЗАГРУЗКА!${NC}"
            echo -e "${CYAN}║${RED} Причина: $REBOOT_REASON${NC}"
        fi
    fi
    
    # Информация о безопасности и сервисах
    echo -e "${CYAN}║${NC}"
    echo -e "${CYAN}║${GREEN} ✓ SSH порт: 47291${NC}"
    echo -e "${CYAN}║${GREEN} ✓ Fail2Ban активен${NC}"
    echo -e "${CYAN}║${GREEN} ✓ Автообновления включены${NC}"
    
    # Статус ClamAV
    if systemctl is-active --quiet clamav-freshclam; then
        echo -e "${CYAN}║${GREEN} ✓ ClamAV: Активен${NC}"
    else
        echo -e "${CYAN}║${RED} ✗ ClamAV: Неактивен${NC}"
    fi
    
    # Статус Nginx
    if systemctl is-active --quiet nginx; then
        echo -e "${CYAN}║${GREEN} ✓ Nginx: Активен${NC}"
    else
        echo -e "${CYAN}║${RED} ✗ Nginx: Неактивен${NC}"
    fi
    
    # Статус Audit
    if systemctl is-active --quiet auditd; then
        echo -e "${CYAN}║${GREEN} ✓ Audit: Активен${NC}"
    else
        echo -e "${CYAN}║${RED} ✗ Audit: Неактивен${NC}"
    fi
    
    echo -e "${CYAN}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}Управление tmux:${NC}"
    echo -e "  ${CYAN}Ctrl+B затем 0${NC} - Переключиться на окно Welcome"
    echo -e "  ${CYAN}Ctrl+B затем 1${NC} - Переключиться на окно Monitor (bashtop)"
    echo -e "  ${CYAN}Ctrl+B затем c${NC} - Создать новое окно"
    echo -e "  ${CYAN}Ctrl+B затем d${NC} - Отключиться от сессии (сессия продолжит работать)"
    echo ""
}

# Основная функция
main() {
    get_system_info
    
    # Заглушка для дополнительных уведомлений
    if [ -f /tmp/admin-messages ]; then
        echo -e "${YELLOW}📢 Сообщения администратора:${NC}"
        cat /tmp/admin-messages
        echo ""
    fi
}

# Запуск только если скрипт вызван напрямую
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
